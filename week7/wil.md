# Chapter 4. Implementing B-Trees
## Rebalancing
일부 B-Tree 구현에서는 split과 merge 비용을 분산시키기 위한 시도가 있음.<br>
레벨 내에서 재배치하거나 occupancy가 높은 노드에서 낮은 노드로 데이터를 이동시켜,<br>
가능한 한 오랫동안 split이나 merge를 미루려고 함.<br>
=> occupancy 낮추고 트리 레벨 수 줄일 수 있지만, rebalancing 비용이 더 들 수 있음.<br>

삽입이나 삭제 연산 중에 load balancing이 수행될 수 있음.<br>
삽입 과정에서 오버플로우가 발생했을 때 노드를 분할하는 대신, 일부 요소를 형제 노드로 옮겨 삽입 공간을 마련.<br>
삭제 시에는 형제 노드를 병합하는 대신, 이웃 노드에서 가져와 노드가 최소 절반 이상 차도록 할 수 있음.<br>

B*-Tree는 두 형제 노드가 모두 가득 찰 때까지 데이터를 서로 분배.<br>
그 후에는 가득찬 노드를 두 개의 절반짜리 노드로 분할하는 대신,<br>
두 노드를 세 개의 노드로 분할하여 각각 2/3씩 채우는 방식을 사용.<br>
이 방식은 split을 미루어 평균 점유율을 높이지만, 추가적인 추적 및 밸런싱 로직이 필요함.<br>
점유율이 높아지면 트리의 높이가 작아지고, 검색 시 거쳐야 하는 페이지 수가 줄어들어 검색 효율도 향상.<br>

## Right-Only Appends
기본 인덱스 키를 auto-increment로 사용하는 경우가 많은데,<br> 
이런 경우 모든 삽입이 인덱스의 오른쪽 끝에서 발생.<br>

auto-increment 때문에 삽입보다 수정 및 삭제 비율이 낮은 경우,<br>
비단말 페이지들도 무작위 키 순서일 때보다 단편화가 적음.<br>

PostgreSQL은 이를 **fastpath**라고 부르는데,<br>
가장 오른쪽 페이지에 새로 삽입될 항목을 담을 충분한 공간이 있는 경우, 새로운 항목은 캐시된 가장 오른쪽 리프의 적절한 위치에 삽입됨.<br>
따라서 전체 읽기 경로(read path)를 건너뛸 수 있음.<br>

SQLite는 **quickbalance**라고 부름.<br>
항목이 트리의 가장 오른쪽 끝에 삽입되고 대상 노드가 가득 찼을 때,<br>
새로운 가장 오른쪽 노드를 할당하여 부모에 그 포인터를 추가.<br>
새로 생성된 페이지는 거의 비어 있게 되지만 곧 채워짐.<br>

### Bulk Loading
만약 이미 정렬된 데이터를 가지고 있고 이를 대량으로 로드하고자 하거나 defragmentation을 위해 트리를 재구성해야 한다면,
right-only appends를 응용 가능.<br>
트리 생성에 필요한 데이터가 이미 정렬되어 있으므로, bulk loading 과정에서는 아이템을 트리의 가장 오른쪽 위치에 순차적으로 추가하기만 하면 됨.<br>
이렇게 하면 분할이나 병합을 전혀 수행하지 않고도 트리를 bottom up으로 구성할 수 있으며,<br>
레벨별로 데이터를 기록하거나,<br>
하위 레벨 노드에 대한 포인터가 충분히 모이면 상위 레벨 노드를 바로 작성 가능.<br>

Bulk loading을 구현하는 한 가지 방법은, 정렬된 데이터를 leaf 레벨에 페이지 단위로 기록하는 것.<br>
각 리프 페이지가 완성된 후에는 그 페이지의 첫 번째 키를 부모 노드에 복사하여 상위 B-Tree 레벨을 구축.<br>
역시나 삽입되는 키들이 정렬되어 있기 때문에 모든 분할은 오른쪽 끝 노드에서만 발생.<br>

B-Tree는 항상 리프 레벨부터 구축되므로, 리프 레벨 전체를 상위 노드보다 먼저 구성 가능.<br>
상위 레벨을 구성할 때 이미 모든 하위 노드 포인터를 확보할 수 있고,<br>
디스크상에서 분할이나 병합을 수행할 필요가 없으며, 트리 생성 과정 동안 메모리에는 현재 채우고 있는 리프 노드의 모든 부모 노드만 유지하면 된다.<br>

불변 B-Tree도 같은 방식으로 생성할 수 있지만, 변경이 불가능하므로 이후 수정에 대한 공간 오버헤드가 필요 없음.<br>
occupancy, performance 높아짐.<br>

## Compression

## Vacuum and Maintenance

## Summary